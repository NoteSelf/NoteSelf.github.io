language: node_js
cache:
  directories:
    - ~/.npm
node_js:
  - "10"
before_install:
  - "npm i -g tiddlywiki@5.1.21"
  # note that I'm naming the output folders for easier reference later
  - "git clone https://github.com/danielo515/tiddlypouch.git tpouch"
  - "git clone https://github.com/felixhayashi/TW5-TiddlyMap.git tiddlymap" # required by tiddlymap edition
  - "git clone https://github.com/felixhayashi/TW5-Vis.js.git vis" # required by tiddlymap
  - "ls -l"
before_script:
 - export TIDDLYWIKI_PLUGIN_PATH="$(pwd)/plugins:$(pwd)/node_modules/tw-pouchdb:$(pwd)/tpouch/dist:$(pwd)/tiddlymap/dist:$(pwd)/vis/dist" # Plugins paths with all deps globally available
 - "(cd tpouch && yarn && gulp travis --production)"
script:
 # ===== Builds NoteSelf core plugins
 - npm run build-plugin 
 # ===== Build the editions
 - tiddlywiki ./wiki --verbose --output ./dist --build index --build favicon --build library
 - | 
    for edition in editions/*; do
      tiddlywiki $edition --verbose --build index
    done
 # ===== Non Minified version =====
 - "(cd ./tpouch && gulp travis)" # Build non minified version of TPouch code ( no --production flag )
 - tiddlywiki ./editions/online --verbose --build dev # This is the same as the online one, but to a different dist path
 # ===== Build edge version with the latest tiddlywiki and experimental plugins =====
 - "npm i tiddlywiki@latest  && npx tiddlywiki --version"
 - "npx tiddlywiki ./editions/edge --verbose --build index" # build the edge edition (includes not well tested stuff)
 # === Measures file sizes and adds that data to the pull request ===
 # The var on the for loop includes each path with a trailing slash (/)
 - |
    for edition in dist/*/; do
      python node_modules/travis-weigh-in/weigh_in.py ${edition}index.html || true 
    done
 - python node_modules/travis-weigh-in/weigh_in.py dist/index.html || true
 - python node_modules/travis-weigh-in/weigh_in.py dist/offline.html || true
after_script:
 - "ls -lR dist"
deploy:
  provider: pages
  skip_cleanup: true
  local_dir: ./dist
  target_branch: master
  github_token: $GITHUB_TOKEN # Set in travis-ci.org dashboard
  on:
    branch: develop
